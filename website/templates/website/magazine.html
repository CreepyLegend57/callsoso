{% extends "website/base.html" %}
{% load static %}
{% now "Y" as current_year %}

{% block title %}Call Soso - Magazine Archive{% endblock %}

{% block extra_css %}
<!-- You can add your CSS here later to match the style -->
{% endblock %}

{% block content %}
<main class="magazine-page">

  <!-- HERO -->
  <header class="magazine-hero">
    <h1 id="mag-hero-title">Magazine Archive</h1>
    <p class="subtitle">Exclusive digital magazines for members â€” browse featured issues, read previews, and dive into circular economy stories.</p>
  </header>

  <!-- Top search bar -->
  <div class="magazine-top-bar" style="margin-bottom:30px;">
    <form method="get" action="{% url 'website:magazine' %}" class="magazine-search enhanced-search" style="flex:1; max-width:600px;">
      <input type="text" name="q" placeholder="Search issues by title or topic..." value="{{ search_query|default:'' }}">
      {% if selected_category %}
        <input type="hidden" name="category" value="{{ selected_category }}">
      {% endif %}
      <button type="submit">Search</button>
    </form>
  </div>

  <!-- Main layout -->
  <section class="magazine-wrapper" style="display:flex; gap:32px; align-items:flex-start; flex-wrap:wrap;">

    <!-- Sidebar -->
    <aside class="insights-sidebar" style="width:280px; flex: none;">
      <div class="sidebar-section" style="background: #fff; padding:20px; border-radius:12px; box-shadow:0 8px 18px rgba(0,0,0,0.05); margin-bottom:24px;">
        <h4 style="margin-top:0; margin-bottom:16px; font-size:1.1rem; color:#0d4d40; border-bottom:1px solid #f3f4f6; padding-bottom:10px;">Categories</h4>
        <ul class="filter-tabs" style="list-style:none; padding:0; margin:0;">
          <li style="margin-bottom:8px;">
            <a href="{% url 'website:magazine' %}{% if search_query %}?q={{ search_query|urlencode }}{% endif %}"
               class="{% if not selected_category %}active{% endif %}"
               style="text-decoration:none; display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-radius:8px; font-size:0.95rem; {% if not selected_category %} background:#f0fdf4; color:#12b981; font-weight:600; {% else %} color:#4b5563; {% endif %}">
              <span>All Issues</span>
            </a>
          </li>
          {% for category in all_categories %}
          <li style="margin-bottom:8px;">
            <a href="?{% if search_query %}q={{ search_query|urlencode }}&{% endif %}category={{ category.slug }}"
               class="{% if category.slug == selected_category %}active{% endif %}"
               style="text-decoration:none; display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-radius:8px; font-size:0.95rem; {% if category.slug == selected_category %} background:#f0fdf4; color:#12b981; font-weight:600; {% else %} color:#4b5563; {% endif %}">
              <span>{{ category.name }}</span>
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>

      {% if popular_articles %}
      <div class="sidebar-section" aria-labelledby="popular-title" style="background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 18px rgba(0,0,0,0.05); margin-bottom:24px;">
        <h4 id="popular-title" style="margin:0 0 16px; font-size:1.1rem; color:#0d4d40;">Most Popular</h4>
        <ul style="list-style:none; padding:0; margin:0; display:grid; gap:16px;">
          {% for article in popular_articles %}
          <li>
            <div class="popular-article-card" style="display:flex; gap:12px; align-items:start;">
              <div style="width:60px; height:60px; overflow:hidden; border-radius:8px; background:#f3f4f6;">
                {% if article.display_image %}
                <img src="{{ article.display_image }}" alt="{{ article.title }}" loading="lazy" style="width:100%; height:100%; object-fit:cover;">
                {% else %}
                <img src="{% static 'images/placeholder.jpg' %}" alt="Placeholder" loading="lazy" style="width:100%; height:100%; object-fit:cover;">
                {% endif %}
              </div>
              <div class="popular-content" style="flex:1; min-width:0;">
                <h5 style="margin:0 0 4px; font-size:0.85rem;"><a href="{{ article.url }}" style="color:#0d4d40; text-decoration:none;">{{ article.title|truncatewords:8 }}</a></h5>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Join -->
      <div class="sidebar-section" style="padding:20px; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius:12px; text-align:center; border: 1px solid #86efac;">
        <strong style="font-size: 1rem; color: #166534; display: block; margin-bottom: 8px;">Become a Member</strong>
        <p style="margin:0 0 12px; color: #166534; font-size:0.85rem;">Unlock full magazine access.</p>
        <a href="{% url 'website:signup' %}" style="display:inline-block; padding:8px 16px; background:#12b981; color:#fff; border-radius:6px; text-decoration:none; font-size:0.9rem; font-weight:500;">Join Now</a>
      </div>
    </aside>

    <!-- Articles & Issues -->
    <div class="magazine-list" style="flex:1;">

      {% if featured_issues %}
      <section class="featured-issues" aria-labelledby="featured-issues-title" style="margin-bottom:40px;">
        <h2 id="featured-issues-title" style="font-size:1.5rem; margin-bottom:20px;">Featured Issues</h2>
        <div class="featured-issues-slider" id="featured-slider" style="display:flex; gap:18px; overflow-x:auto; padding-bottom:12px; cursor:grab;">
          {% for issue in featured_issues %}
          <article class="featured-issue-card" style="min-width:300px; max-width:300px; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
            <div style="position:relative; height:160px;">
              {% if issue.display_image %}
              <img src="{{ issue.display_image }}" alt="{{ issue.title }}" style="width:100%; height:100%; object-fit:cover;">
              {% endif %}
            </div>
            <div style="padding:16px;">
              <h3 style="margin:0 0 8px; font-size:1.1rem;"><a href="{{ issue.get_absolute_url }}" style="color:#1f2937; text-decoration:none;">{{ issue.title }}</a></h3>
              <p style="margin:0; color:#4b5563; font-size:0.9rem;">{{ issue.description|truncatewords:15 }}</p>
            </div>
          </article>
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <section class="regular-issues" style="margin-top:40px;">
        <h2 id="all-issues-title">{{ selected_category|default:"All" }} Issues</h2>
        {% if regular_issues %}
        <div class="regular-issues-grid" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:20px;">
          {% for issue in regular_issues %}
          <article class="regular-issue-card" style="background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.06); transition:transform 0.2s ease;">
            <div style="height:140px; background:#f3f4f6;">
              {% if issue.display_image %}
              <img src="{{ issue.display_image }}" alt="{{ issue.title }}" style="width:100%; height:100%; object-fit:cover;">
              {% endif %}
            </div>
            <div style="padding:16px;">
              <h4 style="margin:0 0 8px; font-size:1rem;"><a href="{{ issue.get_absolute_url }}" style="color:#1f2937; text-decoration:none;">{{ issue.title }}</a></h4>
              <p style="margin:0; font-size:0.85rem; color:#6b7280;">{{ issue.published_date|date:"M Y" }}</p>
            </div>
          </article>
          {% endfor %}
        </div>
        {% if is_paginated %}
        <div class="pagination" style="margin-top:40px; display:flex; justify-content:center; gap:8px;">
          {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}" style="padding:8px 16px; background:#fff; border:1px solid #d1d5db; border-radius:6px; text-decoration:none; color:#374151;">Previous</a>
          {% endif %}
          <span style="padding:8px 16px; background:#12b981; color:#fff; border-radius:6px;">{{ page_obj.number }}</span>
          {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&q={{ search_query|urlencode }}{% endif %}" style="padding:8px 16px; background:#fff; border:1px solid #d1d5db; border-radius:6px; text-decoration:none; color:#374151;">Next</a>
          {% endif %}
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state" style="text-align:center; padding:60px 20px; background:#f9fafb; border-radius:12px;">
          <p style="color:#6b7280;">No issues found in this category.</p>
        </div>
        {% endif %}
      </section>

    </div>
  </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Slider drag
  const slider = document.getElementById('featured-slider');
  if (slider) {
    let isDown = false, startX, scrollLeft;
    slider.addEventListener('mousedown', (e) => {
      isDown = true; slider.style.cursor = 'grabbing';
      startX = e.pageX - slider.offsetLeft;
      scrollLeft = slider.scrollLeft;
    });
    slider.addEventListener('mouseleave', () => { isDown = false; slider.style.cursor = 'grab'; });
    slider.addEventListener('mouseup', () => { isDown = false; slider.style.cursor = 'grab'; });
    slider.addEventListener('mousemove', (e) => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - slider.offsetLeft;
      const walk = (x - startX) * 2;
      slider.scrollLeft = scrollLeft - walk;
    });
  }

  // Hover effect on cards
  const cards = document.querySelectorAll('.regular-issue-card, .featured-issue-card');
  cards.forEach(card => {
    card.addEventListener('mouseenter', () => {
      card.style.transform = 'translateY(-4px)';
    });
    card.addEventListener('mouseleave', () => {
      card.style.transform = 'translateY(0)';
    });
  });
});
</script>
{% endblock %}